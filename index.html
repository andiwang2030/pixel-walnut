<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Walnut Pixel World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <style>
      html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#1a1a1a; }
      #game-container { width:100%; height:100%; }
      
      /* é¡¶éƒ¨æ ‡é¢˜æ¡ */
      .hud {
        position:fixed; left:0; right:0; top:0; height:48px; 
        display:flex; align-items:center; gap:12px; padding:0 14px;
        background:#101418; color:#aef; font-family:Arial, Helvetica, sans-serif;
        font-size:14px; z-index:10; border-bottom:1px solid #223;
        box-shadow: 0 2px 8px rgba(0,0,0,.35)

        <div id="toolbar" style="position:fixed;left:10px;top:56px;z-index:11;background:#0e141b;border:1px solid #2a3a4a;color:#cfe;padding:8px 10px;border-radius:10px;font:13px Arial;display:flex;gap:8px;align-items:center;">
  <select id="filter-cat">
    <option value="">å…¨éƒ¨åˆ†ç±»</option>
    <option value="retail">é›¶å”®/å·¥ä½œå®¤</option>
    <option value="cafe">å’–å•¡/é¤é¥®</option>
    <option value="service">æœåŠ¡</option>
    <option value="workshop">ä½“éªŒ/è¯¾ç¨‹</option>
  </select>
  <label style="display:flex;gap:6px;align-items:center;">
    <input type="checkbox" id="filter-open"/> è¥ä¸šä¸­
  </label>
  <input id="filter-q" placeholder="æœç´¢åº—å/æ ‡ç­¾" style="padding:6px 8px;border-radius:8px;border:1px solid #244;background:#0A1218;color:#cfe;"/>
  <button id="filter-apply">ç­›é€‰</button>
</div>
<div id="merchant-panel" class="panel" style="right:10px;bottom:auto;top:60px;width:720px;display:none;">
  <div style="display:flex;gap:12px;">
    <!-- å·¦ä¾§ï¼šå•†å®¶ä¿¡æ¯ -->
    <div style="flex:1;min-width:260px;">
      <img id="mp-cover" src="" style="width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:8px;border:1px solid #2a3a4a;"/>
      <div style="display:flex;gap:10px;align-items:center;">
        <img id="mp-logo" src="" style="width:44px;height:44px;border-radius:8px;border:1px solid #2a3a4a;"/>
        <div>
          <h3 id="mp-name" style="margin:0 0 4px 0;"></h3>
          <div id="mp-tags" style="font-size:12px;color:#9fd;"></div>
        </div>
      </div>
      <div id="mp-blurb" style="margin-top:8px;font-size:13px;color:#cfe;"></div>
      <div id="mp-hours" style="margin-top:6px;font-size:12px;color:#9ac;"></div>
      <div id="mp-addr" style="margin-top:6px;font-size:12px;color:#9ac;"></div>
      <div id="mp-contacts" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"></div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" id="btn-review">å†™è¯„ä»·</button>
        <button class="btn" id="btn-fav">â­ æ”¶è—</button>
        <button class="btn" id="btn-route">ğŸ—ºï¸ è·¯çº¿</button>
      </div>
      <div id="mp-reviews" style="margin-top:10px;border-top:1px solid #2a3a4a;padding-top:8px;font-size:12px;color:#cfe;">
        <b>ç¤¾åŒºå£ç¢‘</b>ï¼ˆå…ˆåšæœ¬åœ°å­˜å‚¨ç‰ˆæœ¬ï¼‰
        <div id="mp-reviews-list" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šå•†å“ç½‘æ ¼ -->
    <div style="flex:1.3;min-width:340px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <b>ä¸Šæ¶å•†å“ / ä½“éªŒ</b>
        <button class="btn" id="btn-all-products">æŸ¥çœ‹å…¨éƒ¨</button>
      </div>
      <div id="mp-products" style="margin-top:8px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px;"></div>
    </div>
  </div>
</div>

      }
      .hud .badge { background:#243143; color:#cfe; padding:6px 10px; border-radius:10px; }
      .hud a { color:#8fd; text-decoration:none; }
      
      /* å¼¹çª— */
      .panel {
        position:fixed; right:10px; bottom:10px; width:280px; 
        background:#0e141b; color:#eaf6ff; border:1px solid #2a3a4a;
        border-radius:10px; padding:14px; z-index:20; display:none;
        font-family:Arial, Helvetica, sans-serif;
        box-shadow: 0 8px 24px rgba(0,0,0,.45);
      }
      .panel h3{ margin:0 0 6px 0; font-size:16px; }
      .panel .tag{ display:inline-block; font-size:12px; padding:2px 6px; border-radius:8px; background:#17324a; color:#bfe; margin-right:6px;}
      .panel .btn{ margin-top:10px; display:inline-block; font-size:13px; padding:8px 10px; background:#174; color:#dff; border-radius:8px; cursor:pointer; }
      .panel .btn:hover{ filter:brightness(1.1); }
      /* åº•éƒ¨æç¤º */
      .tip {
        position:fixed; left:50%; transform:translateX(-50%); bottom:12px;
        background:#0d1720; color:#aee; padding:8px 12px; border-radius:10px; 
        border:1px solid #203040; font-family:Arial; font-size:12px; z-index:9;
        box-shadow: 0 6px 18px rgba(0,0,0,.35);
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
  </head>
  <body>
    <div class="hud">
      <div class="badge">ğŸŒ Walnut Pixel World</div>
      <div class="badge">Drag / WASD ç§»åŠ¨ Â· ç‚¹å‡»å»ºç­‘æŸ¥çœ‹</div>
      <div style="flex:1"></div>
      <a href="https://pixel-walnut.vercel.app" target="_blank">Live</a>
    </div>

    <div id="game-container"></div>

    <div id="poi-panel" class="panel">
      <h3 id="poi-name">POI Name</h3>
      <div>
        <span id="poi-cat" class="tag">category</span>
        <span id="poi-reward" class="tag">reward</span>
      </div>
      <div id="poi-note" style="margin-top:8px; font-size:13px; line-height:1.3; color:#cfe;">
        ç‚¹å‡»â€œé¢†å–/ç­¾åˆ°â€ä»…ä½œæ¼”ç¤ºã€‚
      </div>
      <div class="btn" onclick="alert('æ¼”ç¤ºï¼šè¿™é‡Œå°†è¿æ¥åˆ°ç­¾åˆ°/å®ç®±/ä»»åŠ¡é€»è¾‘')">é¢†å–/ç­¾åˆ°</div>
    </div>

    <div class="tip">ğŸ’¡ æç¤ºï¼šé¼ æ ‡æ‹–æ‹½/è§¦æ‘¸æ‹–æ‹½ç§»åŠ¨åœ°å›¾ï¼Œæˆ–ç”¨é”®ç›˜ WASDã€‚</div>

    <script>
     let MERCHANTS = [], PRODUCTS = []; let merchantDots = [];

      // ======== å¯ç¼–è¾‘ï¼šä½ çš„ç¤ºä¾‹ POIï¼ˆä¹‹åæˆ‘ä»¬ä¼šæ”¹æˆä» CSV/æ•°æ®åº“åŠ è½½ï¼‰========
    let POIS = [];

  fetch('poi.json')
    Promise.all([
  fetch('merchants.json').then(r=>r.json()),
  fetch('products.json').then(r=>r.json())
]).then(([ms, ps])=>{
  MERCHANTS = ms; PRODUCTS = ps;
 function placeMerchants(){
  const scene = app.scene.scenes[0];
  // ç®€æ˜“æ ·å¼ï¼šç”¨ä¸åŒé¢œè‰²ä»£è¡¨ç±»åˆ«
  const colorMap = { retail:0xff7f9f, cafe:0x7effb0, service:0x5cc8ff, workshop:0xffde6b };
  MERCHANTS.forEach(m=>{
    const color = colorMap[m.cat] || 0xb0a0ff;
    const g = scene.make.graphics({x:0,y:0,add:false});
    g.fillStyle(color,1); g.fillCircle(0,0,10); g.lineStyle(2,0x0d0f17,1); g.strokeCircle(0,0,10);
    const key = `dot_m_${m.id}`;
    g.generateTexture(key,24,24); g.clear();

    const dot = scene.add.image(m.x, m.y, key).setInteractive({useHandCursor:true}).setDepth(6);
    dot.on('pointerdown', ()=>{
      const dist = Phaser.Math.Distance.Between(player.x, player.y, m.x, m.y);
      if(dist <= INTERACT_DIST*1.5){ openMerchantPanel(m); } else { toast('é è¿‘ä¸€ç‚¹ç‚¹å°±èƒ½æŸ¥çœ‹åº—é“ºå†…æ™¯ä¸å•†å“ï½'); }
    });

    const label = scene.add.text(m.x+16, m.y-10, m.name, {fontFamily:'Arial',fontSize:'12px',color:'#e6fff5',stroke:'#0a0f12',strokeThickness:3}).setDepth(10);
    merchantDots.push({dot,label,merchant:m});
  });
}
; // æ¸²æŸ“åœ°å›¾å•†å®¶ç‚¹
});

  .then(res => res.json())
  .then(data => {
    POIS = data;
    // å½“ JSON åŠ è½½å®Œæˆåå†æ”¾ç½® POI
    placePOIs();
  });

  function placePOIs() {
  POIS.forEach(p => {
    const key = {
      city_hall:"dot_cityhall",
      library:"dot_library",
      park:"dot_park",
      post_office:"dot_post",
      retail:"dot_retail"
    }[p.cat] || "dot_retail";

    const dot = app.scene.scenes[0].add.image(p.x, p.y, key).setInteractive({useHandCursor:true});
     dot.on("pointerdown", ()=>{
    const dist = Phaser.Math.Distance.Between(player.x, player.y, p.x, p.y);
    if(dist <= INTERACT_DIST){
      openPanel(p);
    } else {
      toast("å†é è¿‘ä¸€ç‚¹ç‚¹å°±èƒ½ä¸è¯¥åœ°ç‚¹äº’åŠ¨å•¦ï½");
    }
  });


    app.scene.scenes[0].add.text(p.x+16, p.y-10, p.name, {
      fontFamily:"Arial", fontSize:"12px", color:"#e6fff5",
      stroke:"#0a0f12", strokeThickness:3
    }).setDepth(10);
  });
}


      // ======== Phaser åŸºç¡€é…ç½® ========
      const WorldWidth = 3200;   // ä¸–ç•Œå®½
      const WorldHeight = 2200;  // ä¸–ç•Œé«˜
      const app = new Phaser.Game({
        type: Phaser.AUTO,
        parent: "game-container",
        width: window.innerWidth,
        height: window.innerHeight,
        pixelArt: true,
        backgroundColor: "#183024",
        scene: { preload, create, update },
        physics: { default: "arcade" }
      });

      
      let camera, cursors, dragging = false, dragX=0, dragY=0;
      let player, keys, sceneRef;
      const INTERACT_DIST = 120; // ä¸POIäº¤äº’è·ç¦»åƒç´ 


      function preload(){
        // ç”¨å›¾å½¢ç”Ÿæˆå‡ ç§ç®€æ˜“è´´å›¾ï¼ˆè‰åœ°å—ã€é“è·¯ã€POIæ ‡è®°ï¼‰
        // è‰å—
        const g = this.make.graphics({x:0,y:0, add:false});
        g.fillStyle(0x245c3c,1); g.fillRect(0,0,64,64);
        g.lineStyle(2, 0x2d7a50, 1);
        g.strokeRect(1,1,62,62);
        g.generateTexture("tile_grass",64,64);
        g.clear();
        // é“è·¯å—
        g.fillStyle(0xc6a15b,1); g.fillRect(0,0,64,64);
        g.lineStyle(2,0xa58445,1); g.strokeRect(1,1,62,62);
        g.generateTexture("tile_road",64,64);
        g.clear();
        // POI ç‚¹ï¼ˆå½©è‰²åœ†ï¼‰
        const makeCircle = (key,color) => {
          g.fillStyle(color,1); g.fillCircle(12,12,12);
          g.lineStyle(2,0x0d0f17,1); g.strokeCircle(12,12,12);
          g.generateTexture(key,24,24); g.clear();
        }
        makeCircle("dot_cityhall", 0x5cc8ff);
        makeCircle("dot_library",  0x7effb0);
        makeCircle("dot_park",     0x85e36b);
        makeCircle("dot_post",     0xffde6b);
        makeCircle("dot_retail",   0xff7f9f);
        // ä¸»è§’è´´å›¾ï¼ˆç”¨ç”»å¸ƒç”Ÿæˆä¸€ä¸ªå°æ–¹å—+çœ¼ç›ï¼‰
        const pg = this.make.graphics({x:0,y:0, add:false});
        pg.fillStyle(0x4bd3a0, 1);
        pg.fillRect(0,0,24,24);
        pg.fillStyle(0x083c2c,1);
        pg.fillCircle(7,9,2);
        pg.fillCircle(17,9,2);
        pg.fillRect(6,16,12,3);
        pg.generateTexture("hero",24,24)
        pg.clear();

     }

      function create(){
        camera = this.cameras.main;
        camera.setBounds(0,0, WorldWidth, WorldHeight);
        this.physics.world.setBounds(0, 0, WorldWidth, WorldHeight);
        camera.setZoom(1);

        // èƒŒæ™¯è‰åœ°æ‹¼è´´
        const cols = Math.ceil(WorldWidth/64);
        const rows = Math.ceil(WorldHeight/64);
        for(let i=0;i<cols;i++){
          for(let j=0;j<rows;j++){
            this.add.image(i*64+32, j*64+32, "tile_grass").setDepth(0);
          }
        }
        // ç®€å•é“è·¯ï¼ˆç¤ºä¾‹ï¼šæ¨ªç«–å‡ æ¡ï¼‰
        for(let x=0;x<WorldWidth; x+=64){ // ä¸€æ¡ä¸œè¥¿å‘è·¯
          this.add.image(x+32, 1280, "tile_road").setDepth(1);
          this.add.image(x+32, 1408, "tile_road").setDepth(1);
        }
        for(let y=0;y<WorldHeight; y+=64){ // ä¸€æ¡å—åŒ—å‘è·¯
          this.add.image(1856, y+32, "tile_road").setDepth(1);
          this.add.image(1984, y+32, "tile_road").setDepth(1);
        }
        sceneRef = this;

        // åˆ›å»ºä¸»è§’ï¼ˆåˆå§‹åæ ‡å¯è°ƒï¼‰
        player = this.physics.add.image(1905,1320, "hero")

          .setDepth(5)
          .setCollideWorldBounds(true);
        
        // ç›¸æœºè·Ÿéšä¸»è§’
        camera.startFollow(player, true, 0.1, 0.1);
        
        // é”®ç›˜ï¼ˆæ–¹å‘é”® + WASDï¼‰
        keys = this.input.keyboard.addKeys({
          up: "W", left: "A", down: "S", right: "D",
          up2: "UP", left2: "LEFT", down2: "DOWN", right2: "RIGHT",
          interact: "SPACE"
        });

        // æ”¾ç½® POI
        POIS.forEach(p=>{
          const key = {
            city_hall:"dot_cityhall",
            library:"dot_library",
            park:"dot_park",
            post_office:"dot_post",
            retail:"dot_retail"
          }[p.cat] || "dot_retail";

          const dot = this.add.image(p.x, p.y, key).setInteractive({useHandCursor:true});
          dot.on("pointerdown", ()=> openPanel(p));
          // æ ‡ç­¾ï¼ˆåƒç´ å­—ä½“ç”¨æ™®é€šæ–‡æœ¬ä»£æ›¿ï¼‰
          const label = this.add.text(p.x+16, p.y-10, p.name, {
            fontFamily: "Arial", fontSize: "12px", color: "#e6fff5", stroke:"#0a0f12", strokeThickness:3
          }).setDepth(10);
        });

        // é¼ æ ‡/è§¦æ‘¸æ‹–æ‹½ç›¸æœº
        this.input.on("pointerdown", (pointer)=>{
          dragging = true; dragX=pointer.x; dragY=pointer.y;
        });
        this.input.on("pointerup", ()=> dragging=false);
        this.input.on("pointermove", (pointer)=>{
          if(!dragging) return;
          const dx = pointer.x - dragX;
          const dy = pointer.y - dragY;
          camera.scrollX -= dx / camera.zoom;
          camera.scrollY -= dy / camera.zoom;
          dragX = pointer.x; dragY = pointer.y;
        });

        // é”®ç›˜ç§»åŠ¨
        cursors = this.input.keyboard.addKeys({ up:"W", left:"A", down:"S", right:"D" });

        // æ»šè½®ç¼©æ”¾ï¼ˆå¯é€‰ï¼‰
        this.input.on("wheel", (pointer, gameObjects, deltaX, deltaY)=>{
          const z = Phaser.Math.Clamp(camera.zoom - deltaY*0.001, 0.5, 2.5);
          camera.setZoom(z);
        });

        // è‡ªé€‚åº”çª—å£
        window.addEventListener("resize", ()=>{
          app.scale.resize(window.innerWidth, window.innerHeight);
        });
      }

         function update(){
        const speed = 180; // ä¸»è§’é€Ÿåº¦
        let vx = 0, vy = 0;
      
        if(keys.left.isDown || keys.left2.isDown)  vx = -speed;
        if(keys.right.isDown || keys.right2.isDown) vx = speed;
        if(keys.up.isDown || keys.up2.isDown)      vy = -speed;
        if(keys.down.isDown || keys.down2.isDown)  vy = speed;
      
        // æ–œå‘ç§»åŠ¨ç­‰é€Ÿ
        if(vx !== 0 && vy !== 0){ vx *= Math.SQRT1_2; vy *= Math.SQRT1_2; }
      
        player.setVelocity(vx, vy);
      
        // ç©ºæ ¼é”® = äº¤äº’æœ€è¿‘çš„POIï¼ˆåœ¨èŒƒå›´å†…æ‰å¯ï¼‰
        if(Phaser.Input.Keyboard.JustDown(keys.interact)){
          const nearest = findNearestPOI(player.x, player.y, INTERACT_DIST);
          if(nearest){
            openPanel(nearest);
          } else {
            toast("é è¿‘ä¸€ä¸ªåœ°ç‚¹å†æŒ‰ç©ºæ ¼è¿›è¡Œäº¤äº’");
          }
        }
      }


      // ç®€æ˜“é¢æ¿
      function openPanel(p){
        document.getElementById("poi-name").textContent = p.name;
        document.getElementById("poi-cat").textContent = p.cat;
        document.getElementById("poi-reward").textContent = p.reward || "+?";
        document.getElementById("poi-note").textContent = p.note || "";
        const panel = document.getElementById("poi-panel");
        panel.style.display = "block";
      }

      // ç‚¹å‡»é¡¶éƒ¨æ ‡é¢˜å¯å…³é—­é¢æ¿ï¼ˆä¹Ÿå¯è‡ªè¡ŒåŠ å…³é—­æŒ‰é’®ï¼‰
      document.querySelector(".hud").addEventListener("click", ()=>{
        document.getElementById("poi-panel").style.display = "none";
      });

          function findNearestPOI(x, y, maxDist=120){
      if(!POIS || !POIS.length) return null;
      let best = null, bestD = Infinity;
      for(const p of POIS){
        const d = Phaser.Math.Distance.Between(x,y,p.x,p.y);
        if(d < bestD && d <= maxDist){ best = p; bestD = d; }
      }
      return best;
    }
    
    // å³ä¸‹è§’å°æç¤ºï¼ˆè½»é‡toastï¼‰
    let toastTimer = null;
    function toast(msg){
      let el = document.getElementById("toast-tip");
      if(!el){
        el = document.createElement("div");
        el.id = "toast-tip";
        el.className = "tip";
        el.style.bottom = "70px";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ el.style.display = "none"; }, 1800);
    }
      function openMerchantPanel(m){
  // å·¦æ 
  document.getElementById('mp-cover').src = m.cover || '';
  document.getElementById('mp-logo').src = m.logo || '';
  document.getElementById('mp-name').textContent = m.name;
  document.getElementById('mp-tags').textContent = (m.tags||[]).join(' Â· ');
  document.getElementById('mp-blurb').textContent = m.blurb || '';
  document.getElementById('mp-hours').textContent = 'è¥ä¸šæ—¶é—´ï¼š' + (m.hours || 'æœªæä¾›');
  document.getElementById('mp-addr').textContent = m.address_hint || '';
  // è”ç³»æ–¹å¼
  const c = document.getElementById('mp-contacts'); c.innerHTML = '';
  (m.contacts||[]).forEach(o=>{
    const a = document.createElement('a'); a.href = o.u; a.target = '_blank'; a.className='btn';
    a.textContent = ({phone:'â˜ ç”µè¯', whatsapp:'WhatsApp', instagram:'Instagram', site:'ç½‘ç«™', email:'é‚®ä»¶'})[o.t] || 'è”ç³»';
    c.appendChild(a);
  });

  // å³æ ï¼šå•†å“
  const wrap = document.getElementById('mp-products'); wrap.innerHTML='';
  const list = PRODUCTS.filter(p=>p.merchant_id===m.id).slice(0,6);
  list.forEach(p=>{
    const card = document.createElement('div'); card.style.cssText='border:1px solid #2a3a4a;border-radius:10px;overflow:hidden;background:#0b1218;';
    card.innerHTML = `
      <img src="${(p.media&&p.media[0])||''}" style="width:100%;height:120px;object-fit:cover;"/>
      <div style="padding:8px;">
        <div style="font-size:13px;color:#eaf6ff">${p.title}</div>
        <div style="font-size:12px;color:#9fd;margin-top:4px;">$${p.price} ${p.currency||''} ${p.bookable?'Â· å¯é¢„çº¦':''}</div>
        <button class="btn" style="margin-top:8px;width:100%;" onclick="openProduct('${p.id}')">è´­ä¹° / é¢„çº¦</button>
      </div>`;
    wrap.appendChild(card);
  });

  document.getElementById('merchant-panel').style.display='block';
}
function openProduct(pid){
  const p = PRODUCTS.find(x=>x.id===pid);
  if(!p) return;
  if(p.purchase_url){ window.open(p.purchase_url, '_blank'); }
}
document.getElementById('filter-apply').addEventListener('click', applyFilters);
function applyFilters(){
  const cat = document.getElementById('filter-cat').value.trim();
  const q = document.getElementById('filter-q').value.trim().toLowerCase();
  // â€œè¥ä¸šä¸­â€å…ˆå¿½ç•¥ï¼Œæœªæ¥æ¥å®æ—¶è¥ä¸šåˆ¤æ–­
  merchantDots.forEach(({dot,label,merchant:m})=>{
    let show = true;
    if(cat && m.cat!==cat) show=false;
    if(q){
      const hay = (m.name+' '+(m.tags||[]).join(' ')+' '+(m.blurb||'')).toLowerCase();
      if(!hay.includes(q)) show=false;
    }
    dot.visible = label.visible = show;
  });
}


    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>City OS Â· å•†ä¸šåœ°å›¾ MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <style>
      html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#1a1a1a; }
      #game-container { width:100%; height:100%; }
      .hud {
        position:fixed; left:0; right:0; top:0; height:48px;
        display:flex; align-items:center; gap:12px; padding:0 14px;
        background:#101418; color:#aef; font-family:Arial, Helvetica, sans-serif;
        font-size:14px; z-index:20; border-bottom:1px solid #223;
        box-shadow: 0 2px 8px rgba(0,0,0,.35);
      }
      .hud .badge { background:#243143; color:#cfe; padding:6px 10px; border-radius:10px; }
      .hud a { color:#8fd; text-decoration:none; }
      .panel {
        position:fixed; right:10px; bottom:auto; top:60px; width:720px;
        background:#0e141b; color:#eaf6ff; border:1px solid #2a3a4a;
        border-radius:10px; padding:14px; z-index:15; display:none;
        font-family:Arial, Helvetica, sans-serif;
        box-shadow: 0 12px 28px rgba(0,0,0,.5);
      }
      .btn {
        display:inline-block; font-size:13px; padding:8px 10px; background:#174;
        color:#dff; border-radius:8px; cursor:pointer; border:0;
      }
      .btn:hover { filter:brightness(1.1);}
      .tag { display:inline-block; font-size:12px; padding:2px 6px; border-radius:8px; background:#17324a; color:#bfe; margin-right:6px;}
      .tip {
        position:fixed; left:50%; transform:translateX(-50%); bottom:12px;
        background:#0d1720; color:#aee; padding:8px 12px; border-radius:10px;
        border:1px solid #203040; font-family:Arial; font-size:12px; z-index:9;
        box-shadow: 0 6px 18px rgba(0,0,0,.35);
      }
      /* é¡¶éƒ¨ç­›é€‰æ¡ */
      #toolbar {
        position:fixed; left:10px; top:56px; z-index:14; background:#0e141b;
        border:1px solid #2a3a4a; color:#cfe; padding:8px 10px; border-radius:10px;
        font:13px Arial; display:flex; gap:8px; align-items:center;
      }
      #toolbar input, #toolbar select, #toolbar button {
        background:#0A1218; color:#cfe; border:1px solid #244; border-radius:8px; padding:6px 8px;
      }
      #toolbar button { background:#17324a; cursor:pointer; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
  </head>
  <body>
    <!-- é¡¶éƒ¨æ  -->
    <div class="hud" id="topbar">
      <div class="badge">ğŸ™ï¸ City OS Â· å•†ä¸šåœ°å›¾ MVP</div>
      <div class="badge">æ‹–æ‹½/æ»šè½®ç¼©æ”¾ Â· WASD/æ–¹å‘é”®ç§»åŠ¨ Â· é è¿‘å•†å®¶ç‚¹å‡»æŸ¥çœ‹</div>
      <div style="flex:1"></div>
      <a href="#" id="closeAll">å…³é—­é¢æ¿</a>
    </div>

    <!-- ç­›é€‰å·¥å…·æ¡ -->
    <div id="toolbar">
      <select id="filter-cat" title="åˆ†ç±»">
        <option value="">å…¨éƒ¨åˆ†ç±»</option>
        <option value="retail">é›¶å”®/å·¥ä½œå®¤</option>
        <option value="cafe">å’–å•¡/é¤é¥®</option>
        <option value="service">æœåŠ¡</option>
        <option value="workshop">ä½“éªŒ/è¯¾ç¨‹</option>
      </select>
      <input id="filter-q" placeholder="æœç´¢åº—å/æ ‡ç­¾/ç®€ä»‹" title="å…³é”®è¯"/>
      <button id="filter-apply">ç­›é€‰</button>
      <button id="filter-reset">é‡ç½®</button>
    </div>

    <!-- æ¸¸æˆç”»å¸ƒ -->
    <div id="game-container"></div>

    <!-- å•†å®¶ä¾§è¾¹é¢æ¿ï¼ˆå·¦ä¿¡æ¯ + å³å•†å“ï¼‰ -->
    <div id="merchant-panel" class="panel">
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <!-- å·¦ä¾§ä¿¡æ¯ -->
        <div style="flex:1;min-width:260px;">
          <img id="mp-cover" src="" style="width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:8px;border:1px solid #2a3a4a;"/>
          <div style="display:flex;gap:10px;align-items:center;">
            <div style="width:44px;height:44px;border-radius:8px;border:1px solid #2a3a4a;overflow:hidden;background:#091218;">
              <img id="mp-logo" src="" style="width:44px;height:44px;object-fit:cover;"/>
            </div>
            <div>
              <h3 id="mp-name" style="margin:0 0 4px 0;"></h3>
              <div id="mp-tags" style="font-size:12px;color:#9fd;"></div>
            </div>
          </div>
          <div id="mp-blurb" style="margin-top:8px;font-size:13px;color:#cfe;"></div>
          <div id="mp-hours" style="margin-top:6px;font-size:12px;color:#9ac;"></div>
          <div id="mp-addr" style="margin-top:6px;font-size:12px;color:#9ac;"></div>
          <div id="mp-contacts" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"></div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn" id="btn-fav">â­ æ”¶è—</button>
            <button class="btn" id="btn-route">ğŸ—ºï¸ è·¯çº¿</button>
          </div>
        </div>
        <!-- å³ä¾§å•†å“ -->
        <div style="flex:1.3;min-width:340px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <b>ä¸Šæ¶å•†å“ / ä½“éªŒ</b>
            <button class="btn" id="btn-all-products">æŸ¥çœ‹å…¨éƒ¨</button>
          </div>
          <div id="mp-products" style="margin-top:8px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px;"></div>
        </div>
      </div>
    </div>

    <!-- æç¤º -->
    <div class="tip" id="toast" style="display:none;"></div>

    <script>
      // -------------------------
      // è¿è¡Œå‚æ•°ï¼ˆä¸–ç•Œå¤§å°ã€äº¤äº’è·ç¦»ï¼‰
      // -------------------------
      const WorldWidth = 3200;
      const WorldHeight = 2200;
      const INTERACT_DIST = 160;

      // -------------------------
      // æ•°æ®ï¼šç¤ºä¾‹å•†å®¶ & å•†å“ï¼ˆè‡ªåŒ…å«ï¼Œä¸ç”¨å¤–éƒ¨ JSONï¼‰
      // æ›¿æ¢è¿™é‡Œå³å¯æ›´æ–°æ•°æ®
      // -------------------------
      const MERCHANTS = [
        {
          id: "m_crystalmart",
          name: "Crystal Mart Â· å¼€æ”¾å·¥ä½œå°",
          cat: "retail",
          x: 1950, y: 1350,
          logo: "", // å¯æ”¾ä½ çš„åº—æ ‡URL
          cover: "", // å¯æ”¾ä½ çš„åº—å†…ç…§URL
          blurb: "çŸ¿ç‰©é›•åˆ»Â·å±•é™ˆÂ·å…¥é—¨çŸ¿æ ‡ï¼Œå¼€æ”¾å‚è§‚ä¸ä½“éªŒã€‚",
          address_hint: "Calle Vista é™„è¿‘ï¼ˆé“è·¯çº§ï¼‰",
          hours: "Monâ€“Sun 10:00â€“19:00",
          services: ["in_store","pickup","workshop"],
          contacts: [
            {t:"phone",u:"tel:+1-626-000-0000"},
            {t:"site",u:"https://example.com"}
          ],
          rating: 4.9, reviews_count: 36,
          tags: ["çŸ¿ç‰©","æ‰‹ä½œ","æœ¬åœ°å·¥ä½œå®¤"],
          verified: true,
          highlights: ["å¯é¢„çº¦å°è¯¾","å¯å®šåˆ¶å°ä»¶","è®²è§£çŸ¿ç‰©æ•…äº‹"]
        },
        {
          id: "m_snow_coffee",
          name: "Snow Creek Coffee",
          cat: "cafe",
          x: 1600, y: 1480,
          logo: "",
          cover: "",
          blurb: "è‡ªçƒ˜ç²¾å“ï¼Œå‘¨å…­æ‹‰èŠ±ä½“éªŒã€‚",
          address_hint: "Snow Creek å…¬å›­ä¾§",
          hours: "Daily 07:30â€“18:30",
          services: ["in_store","pickup"],
          contacts: [
            {t:"phone",u:"tel:+1-626-111-1111"},
            {t:"instagram",u:"https://instagram.com/coffee_demo"}
          ],
          rating: 4.7, reviews_count: 128,
          tags: ["å’–å•¡","ç”œç‚¹","ä½“éªŒè¯¾"],
          verified: false,
          highlights: ["æ‰‹å†²å§å°","æœ¬åœ°è±†"]
        }
      ];

      const PRODUCTS = [
        {
          id:"p_cm_001", merchant_id:"m_crystalmart",
          title:"å…¥é—¨çŸ¿æ ‡å°å¥—è£…", price:39, currency:"USD",
          media:[""], stock_status:"in_stock",
          purchase_url:"https://example.com/products/starter",
          bookable:false, desc:"é€‚åˆç¬¬ä¸€æ¬¡æ¥è§¦çŸ¿ç‰©çš„ä½ ï¼Œé™„åŸºç¡€ç§‘æ™®å¡ç‰‡ã€‚",
          tags:["ç¤¼ç‰©","å…¥é—¨","ç§‘æ™®"]
        },
        {
          id:"p_cm_ws_01", merchant_id:"m_crystalmart",
          title:"æ‰“ç£¨ä½“éªŒ Â· 30 åˆ†é’Ÿ", price:15, currency:"USD",
          media:[""], stock_status:"limited",
          purchase_url:"https://calendly.com/your-id/30min",
          bookable:true, desc:"åœ¨å·¥ä½œå°ä½“éªŒæŠ›å…‰æµç¨‹ï¼Œå¸¦èµ°ä¸€æšå°çŸ³ã€‚",
          tags:["ä½“éªŒ","æ•™å­¦"]
        },
        {
          id:"p_cafe_001", merchant_id:"m_snow_coffee",
          title:"å‘¨å…­æ‹‰èŠ±ä½“éªŒ", price:12, currency:"USD",
          media:[""], stock_status:"limited",
          purchase_url:"https://calendly.com/coffee/latte-art",
          bookable:true, desc:"æ‰‹æŠŠæ‰‹æ•™ä½ ç”»ä¸€é¢—çˆ±å¿ƒã€‚",
          tags:["ä½“éªŒ","å’–å•¡"]
        }
      ];

      // -------------------------
      // Phaser åˆå§‹åŒ–
      // -------------------------
      const app = new Phaser.Game({
        type: Phaser.AUTO,
        parent: "game-container",
        width: window.innerWidth,
        height: window.innerHeight,
        pixelArt: true,
        backgroundColor: "#183024",
        scene: { preload, create, update },
        physics: { default: "arcade" }
      });

      let camera, player, keys, dragging=false, dragX=0, dragY=0;
      let merchantDots = [];

      function preload(){
        // è‰åœ°
        const g = this.make.graphics({x:0,y:0, add:false});
        g.fillStyle(0x245c3c,1); g.fillRect(0,0,64,64);
        g.lineStyle(2, 0x2d7a50, 1); g.strokeRect(1,1,62,62);
        g.generateTexture("tile_grass",64,64); g.clear();

        // é“è·¯
        g.fillStyle(0xc6a15b,1); g.fillRect(0,0,64,64);
        g.lineStyle(2,0xa58445,1); g.strokeRect(1,1,62,62);
        g.generateTexture("tile_road",64,64); g.clear();

        // å•†å®¶ç‚¹é¢œè‰²
        makeDot(this, "dot_retail",   0xff7f9f);
        makeDot(this, "dot_cafe",     0x7effb0);
        makeDot(this, "dot_service",  0x5cc8ff);
        makeDot(this, "dot_workshop", 0xffde6b);

        // ä¸»è§’
        const pg = this.make.graphics({x:0,y:0, add:false});
        pg.fillStyle(0x4bd3a0, 1); pg.fillRect(0,0,24,24);
        pg.fillStyle(0x083c2c,1); pg.fillCircle(7,9,2); pg.fillCircle(17,9,2);
        pg.fillRect(6,16,12,3); pg.generateTexture("hero",24,24); pg.clear();
      }

      function makeDot(scene, key, color){
        const g = scene.make.graphics({x:0,y:0, add:false});
        g.fillStyle(color,1); g.fillCircle(12,12,12);
        g.lineStyle(2,0x0d0f17,1); g.strokeCircle(12,12,12);
        g.generateTexture(key,24,24); g.clear();
      }

      function create(){
        camera = this.cameras.main;
        camera.setBounds(0,0, WorldWidth, WorldHeight);
        camera.setZoom(1);
        this.physics.world.setBounds(0,0, WorldWidth, WorldHeight);

        // èƒŒæ™¯è‰åœ°
        const cols = Math.ceil(WorldWidth/64);
        const rows = Math.ceil(WorldHeight/64);
        for(let i=0;i<cols;i++){
          for(let j=0;j<rows;j++){
            this.add.image(i*64+32, j*64+32, "tile_grass").setDepth(0);
          }
        }
        // ç®€å•é“è·¯ç½‘
        for(let x=0;x<WorldWidth; x+=64){
          this.add.image(x+32, 1280, "tile_road").setDepth(1);
          this.add.image(x+32, 1408, "tile_road").setDepth(1);
        }
        for(let y=0;y<WorldHeight; y+=64){
          this.add.image(1856, y+32, "tile_road").setDepth(1);
          this.add.image(1984, y+32, "tile_road").setDepth(1);
        }

        // ä¸»è§’
        player = this.physics.add.image(1900, 1320, "hero")
          .setDepth(5).setCollideWorldBounds(true);
        camera.startFollow(player, true, 0.1, 0.1);

        // é”®ç›˜
        keys = this.input.keyboard.addKeys({
          up:"W", left:"A", down:"S", right:"D",
          up2:"UP", left2:"LEFT", down2:"DOWN", right2:"RIGHT",
          interact:"SPACE", esc:"ESC"
        });

        // æ‹–æ‹½ç›¸æœº
        this.input.on("pointerdown", (p)=>{ dragging=true; dragX=p.x; dragY=p.y; });
        this.input.on("pointerup", ()=> dragging=false);
        this.input.on("pointermove", (p)=>{
          if(!dragging) return;
          const dx=p.x-dragX, dy=p.y-dragY;
          camera.scrollX -= dx/camera.zoom; camera.scrollY -= dy/camera.zoom;
          dragX=p.x; dragY=p.y;
        });
        // ç¼©æ”¾
        this.input.on("wheel", (p, go, dx, dy)=>{
          const z = Phaser.Math.Clamp(camera.zoom - dy*0.001, 0.5, 2.5);
          camera.setZoom(z);
        });

        // çª—å£è‡ªé€‚åº”
        window.addEventListener("resize", ()=>{
          app.scale.resize(window.innerWidth, window.innerHeight);
        });

        // æ”¾ç½®å•†å®¶
        placeMerchants();

        // é¡¶éƒ¨æ å…³é—­
        document.getElementById("topbar").addEventListener("click", ()=>{
          document.getElementById("merchant-panel").style.display="none";
        });
        document.getElementById("closeAll").addEventListener("click", (e)=>{
          e.preventDefault();
          document.getElementById("merchant-panel").style.display="none";
        });

        // ç­›é€‰äº‹ä»¶
        document.getElementById("filter-apply").addEventListener("click", applyFilters);
        document.getElementById("filter-reset").addEventListener("click", ()=>{
          document.getElementById("filter-cat").value="";
          document.getElementById("filter-q").value="";
          applyFilters();
        });
      }

      function update(){
        const speed = 180;
        let vx=0, vy=0;
        if(keys.left.isDown || keys.left2.isDown)  vx=-speed;
        if(keys.right.isDown|| keys.right2.isDown) vx=speed;
        if(keys.up.isDown   || keys.up2.isDown)    vy=-speed;
        if(keys.down.isDown || keys.down2.isDown)  vy=speed;
        if(vx!==0 && vy!==0){ vx*=Math.SQRT1_2; vy*=Math.SQRT1_2; }
        player.setVelocity(vx,vy);

        if(Phaser.Input.Keyboard.JustDown(keys.esc)){
          document.getElementById("merchant-panel").style.display="none";
        }
        if(Phaser.Input.Keyboard.JustDown(keys.interact)){
          const m = nearestMerchant(player.x, player.y, INTERACT_DIST);
          if(m){ openMerchantPanel(m); } else { toast("é è¿‘ä¸€ä¸ªå•†å®¶å†æŒ‰ç©ºæ ¼æŸ¥çœ‹å†…æ™¯ä¸å•†å“"); }
        }
      }

      // -------------------------
      // å•†å®¶ç‚¹æ¸²æŸ“ & é¢æ¿
      // -------------------------
      function placeMerchants(){
        const scene = app.scene.scenes[0];
        const keyByCat = { retail:"dot_retail", cafe:"dot_cafe", service:"dot_service", workshop:"dot_workshop" };
        MERCHANTS.forEach(m=>{
          const key = keyByCat[m.cat] || "dot_service";
          const dot = scene.add.image(m.x, m.y, key).setInteractive({useHandCursor:true}).setDepth(6);
          dot.on("pointerdown", ()=>{
            const dist = Phaser.Math.Distance.Between(player.x, player.y, m.x, m.y);
            if(dist <= INTERACT_DIST*1.5){ openMerchantPanel(m); } else { toast("å†é è¿‘ä¸€ç‚¹ç‚¹å°±èƒ½æŸ¥çœ‹åº—é“ºå†…æ™¯ä¸å•†å“ï½"); }
          });
          const label = scene.add.text(m.x+16, m.y-10, m.name, {
            fontFamily:"Arial", fontSize:"12px", color:"#e6fff5", stroke:"#0a0f12", strokeThickness:3
          }).setDepth(10);
          merchantDots.push({dot,label,merchant:m});
        });
      }

      function nearestMerchant(x,y,maxd){
        let best=null, bd=Infinity;
        merchantDots.forEach(({merchant:m})=>{
          const d = Phaser.Math.Distance.Between(x,y,m.x,m.y);
          if(d<bd && d<=maxd){ best=m; bd=d; }
        });
        return best;
      }

      function openMerchantPanel(m){
        // å·¦ä¾§ä¿¡æ¯
        document.getElementById('mp-cover').src = m.cover || '';
        document.getElementById('mp-logo').src  = m.logo  || '';
        document.getElementById('mp-name').textContent = m.name || '';
        document.getElementById('mp-tags').textContent = (m.tags||[]).join(' Â· ');
        document.getElementById('mp-blurb').textContent = m.blurb || '';
        document.getElementById('mp-hours').textContent = 'è¥ä¸šæ—¶é—´ï¼š' + (m.hours || 'æœªæä¾›');
        document.getElementById('mp-addr').textContent  = m.address_hint || '';

        // è”ç³»æ–¹å¼æŒ‰é’®
        const c = document.getElementById('mp-contacts'); c.innerHTML='';
        (m.contacts||[]).forEach(o=>{
          const a = document.createElement('a'); a.href=o.u; a.target='_blank'; a.className='btn';
          a.textContent = ({phone:'â˜ ç”µè¯', whatsapp:'WhatsApp', instagram:'Instagram', site:'ç½‘ç«™', email:'é‚®ä»¶'})[o.t] || 'è”ç³»';
          c.appendChild(a);
        });

        // å³ä¾§å•†å“
        const wrap = document.getElementById('mp-products'); wrap.innerHTML='';
        const list = PRODUCTS.filter(p=>p.merchant_id===m.id).slice(0,6);
        if(list.length===0){
          const empty = document.createElement('div');
          empty.style.cssText='margin:8px 0;color:#9ac;font-size:13px;';
          empty.textContent = 'å•†å®¶å°šæœªä¸Šæ¶å•†å“/ä½“éªŒ';
          wrap.appendChild(empty);
        } else {
          list.forEach(p=>{
            const card=document.createElement('div');
            card.style.cssText='border:1px solid #2a3a4a;border-radius:10px;overflow:hidden;background:#0b1218;';
            card.innerHTML = `
              <div style="width:100%;height:120px;background:#0a1218;display:flex;align-items:center;justify-content:center;">
                ${p.media && p.media[0] ? `<img src="${p.media[0]}" style="width:100%;height:120px;object-fit:cover;"/>` : `<div style="color:#567;font-size:12px;">æ— å›¾</div>`}
              </div>
              <div style="padding:8px;">
                <div style="font-size:13px;color:#eaf6ff">${p.title}</div>
                <div style="font-size:12px;color:#9fd;margin-top:4px;">$${p.price} ${p.currency||''} ${p.bookable?'Â· å¯é¢„çº¦':''}</div>
                <button class="btn" style="margin-top:8px;width:100%;" onclick="openProduct('${p.id}')">è´­ä¹° / é¢„çº¦</button>
              </div>`;
            wrap.appendChild(card);
          });
        }

        // å…¶å®ƒæŒ‰é’®ï¼ˆå ä½ï¼‰
        document.getElementById('btn-fav').onclick = ()=>{ toast('å·²æ”¶è—ï¼ˆæœ¬åœ°æ¼”ç¤ºï¼‰'); };
        document.getElementById('btn-route').onclick = ()=>{ toast('è·¯çº¿åŠŸèƒ½å³å°†ä¸Šçº¿'); };
        document.getElementById('btn-all-products').onclick = ()=>{ toast('æŸ¥çœ‹å…¨éƒ¨ï¼ˆæ¼”ç¤ºï¼‰'); };

        document.getElementById('merchant-panel').style.display='block';
      }

      function openProduct(pid){
        const p = PRODUCTS.find(x=>x.id===pid);
        if(!p) return;
        if(p.purchase_url){ window.open(p.purchase_url, '_blank'); }
        else { toast('æš‚æ— è´­ä¹°/é¢„çº¦é“¾æ¥'); }
      }

      // -------------------------
      // ç­›é€‰
      // -------------------------
      function applyFilters(){
        const cat = document.getElementById('filter-cat').value.trim();
        const q   = document.getElementById('filter-q').value.trim().toLowerCase();
        merchantDots.forEach(({dot,label,merchant:m})=>{
          let show=true;
          if(cat && m.cat!==cat) show=false;
          if(q){
            const hay = (m.name+' '+(m.tags||[]).join(' ')+' '+(m.blurb||'')).toLowerCase();
            if(!hay.includes(q)) show=false;
          }
          dot.visible = label.visible = show;
        });
      }

      // -------------------------
      // æç¤ºå°æ°”æ³¡
      // -------------------------
      let toastTimer=null;
      function toast(msg){
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.style.display='block';
        clearTimeout(toastTimer);
        toastTimer = setTimeout(()=>{ el.style.display='none'; }, 1800);
      }
    </script>
  </body>
</html>

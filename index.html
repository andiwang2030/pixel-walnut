<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Walnut Pixel World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <style>
      html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#1a1a1a; }
      #game-container { width:100%; height:100%; }
      /* é¡¶éƒ¨æ ‡é¢˜æ¡ */
      .hud {
        position:fixed; left:0; right:0; top:0; height:48px; 
        display:flex; align-items:center; gap:12px; padding:0 14px;
        background:#101418; color:#aef; font-family:Arial, Helvetica, sans-serif;
        font-size:14px; z-index:10; border-bottom:1px solid #223;
        box-shadow: 0 2px 8px rgba(0,0,0,.35);
      }
      .hud .badge { background:#243143; color:#cfe; padding:6px 10px; border-radius:10px; }
      .hud a { color:#8fd; text-decoration:none; }
      /* å¼¹çª— */
      .panel {
        position:fixed; right:10px; bottom:10px; width:280px; 
        background:#0e141b; color:#eaf6ff; border:1px solid #2a3a4a;
        border-radius:10px; padding:14px; z-index:20; display:none;
        font-family:Arial, Helvetica, sans-serif;
        box-shadow: 0 8px 24px rgba(0,0,0,.45);
      }
      .panel h3{ margin:0 0 6px 0; font-size:16px; }
      .panel .tag{ display:inline-block; font-size:12px; padding:2px 6px; border-radius:8px; background:#17324a; color:#bfe; margin-right:6px;}
      .panel .btn{ margin-top:10px; display:inline-block; font-size:13px; padding:8px 10px; background:#174; color:#dff; border-radius:8px; cursor:pointer; }
      .panel .btn:hover{ filter:brightness(1.1); }
      /* åº•éƒ¨æç¤º */
      .tip {
        position:fixed; left:50%; transform:translateX(-50%); bottom:12px;
        background:#0d1720; color:#aee; padding:8px 12px; border-radius:10px; 
        border:1px solid #203040; font-family:Arial; font-size:12px; z-index:9;
        box-shadow: 0 6px 18px rgba(0,0,0,.35);
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
  </head>
  <body>
    <div class="hud">
      <div class="badge">ğŸŒ Walnut Pixel World</div>
      <div class="badge">Drag / WASD ç§»åŠ¨ Â· ç‚¹å‡»å»ºç­‘æŸ¥çœ‹</div>
      <div style="flex:1"></div>
      <a href="https://pixel-walnut.vercel.app" target="_blank">Live</a>
    </div>

    <div id="game-container"></div>

    <div id="poi-panel" class="panel">
      <h3 id="poi-name">POI Name</h3>
      <div>
        <span id="poi-cat" class="tag">category</span>
        <span id="poi-reward" class="tag">reward</span>
      </div>
      <div id="poi-note" style="margin-top:8px; font-size:13px; line-height:1.3; color:#cfe;">
        ç‚¹å‡»â€œé¢†å–/ç­¾åˆ°â€ä»…ä½œæ¼”ç¤ºã€‚
      </div>
      <div class="btn" onclick="alert('æ¼”ç¤ºï¼šè¿™é‡Œå°†è¿æ¥åˆ°ç­¾åˆ°/å®ç®±/ä»»åŠ¡é€»è¾‘')">é¢†å–/ç­¾åˆ°</div>
    </div>

    <div class="tip">ğŸ’¡ æç¤ºï¼šé¼ æ ‡æ‹–æ‹½/è§¦æ‘¸æ‹–æ‹½ç§»åŠ¨åœ°å›¾ï¼Œæˆ–ç”¨é”®ç›˜ WASDã€‚</div>

    <script>
     
      // ======== å¯ç¼–è¾‘ï¼šä½ çš„ç¤ºä¾‹ POIï¼ˆä¹‹åæˆ‘ä»¬ä¼šæ”¹æˆä» CSV/æ•°æ®åº“åŠ è½½ï¼‰========
    let POIS = [];

fetch('poi.json')
  .then(res => res.json())
  .then(data => {
    POIS = data;
    // å½“ JSON åŠ è½½å®Œæˆåå†æ”¾ç½® POI
    placePOIs();
  });

function placePOIs() {
  POIS.forEach(p => {
    const key = {
      city_hall:"dot_cityhall",
      library:"dot_library",
      park:"dot_park",
      post_office:"dot_post",
      retail:"dot_retail"
    }[p.cat] || "dot_retail";

    const dot = app.scene.scenes[0].add.image(p.x, p.y, key).setInteractive({useHandCursor:true});
    dot.on("pointerdown", ()=> openPanel(p));

    app.scene.scenes[0].add.text(p.x+16, p.y-10, p.name, {
      fontFamily:"Arial", fontSize:"12px", color:"#e6fff5",
      stroke:"#0a0f12", strokeThickness:3
    }).setDepth(10);
  });
}


      // ======== Phaser åŸºç¡€é…ç½® ========
      const WorldWidth = 3200;   // ä¸–ç•Œå®½
      const WorldHeight = 2200;  // ä¸–ç•Œé«˜
      const app = new Phaser.Game({
        type: Phaser.AUTO,
        parent: "game-container",
        width: window.innerWidth,
        height: window.innerHeight,
        pixelArt: true,
        backgroundColor: "#183024",
        scene: { preload, create, update },
        physics: { default: "arcade" }
      });

      let camera, cursors, dragging = false, dragX=0, dragY=0;

      function preload(){
        // ç”¨å›¾å½¢ç”Ÿæˆå‡ ç§ç®€æ˜“è´´å›¾ï¼ˆè‰åœ°å—ã€é“è·¯ã€POIæ ‡è®°ï¼‰
        // è‰å—
        const g = this.make.graphics({x:0,y:0, add:false});
        g.fillStyle(0x245c3c,1); g.fillRect(0,0,64,64);
        g.lineStyle(2, 0x2d7a50, 1);
        g.strokeRect(1,1,62,62);
        g.generateTexture("tile_grass",64,64);
        g.clear();
        // é“è·¯å—
        g.fillStyle(0xc6a15b,1); g.fillRect(0,0,64,64);
        g.lineStyle(2,0xa58445,1); g.strokeRect(1,1,62,62);
        g.generateTexture("tile_road",64,64);
        g.clear();
        // POI ç‚¹ï¼ˆå½©è‰²åœ†ï¼‰
        const makeCircle = (key,color) => {
          g.fillStyle(color,1); g.fillCircle(12,12,12);
          g.lineStyle(2,0x0d0f17,1); g.strokeCircle(12,12,12);
          g.generateTexture(key,24,24); g.clear();
        }
        makeCircle("dot_cityhall", 0x5cc8ff);
        makeCircle("dot_library",  0x7effb0);
        makeCircle("dot_park",     0x85e36b);
        makeCircle("dot_post",     0xffde6b);
        makeCircle("dot_retail",   0xff7f9f);
      }

      function create(){
        camera = this.cameras.main;
        camera.setBounds(0,0, WorldWidth, WorldHeight);
        camera.setZoom(1);

        // èƒŒæ™¯è‰åœ°æ‹¼è´´
        const cols = Math.ceil(WorldWidth/64);
        const rows = Math.ceil(WorldHeight/64);
        for(let i=0;i<cols;i++){
          for(let j=0;j<rows;j++){
            this.add.image(i*64+32, j*64+32, "tile_grass").setDepth(0);
          }
        }
        // ç®€å•é“è·¯ï¼ˆç¤ºä¾‹ï¼šæ¨ªç«–å‡ æ¡ï¼‰
        for(let x=0;x<WorldWidth; x+=64){ // ä¸€æ¡ä¸œè¥¿å‘è·¯
          this.add.image(x+32, 1280, "tile_road").setDepth(1);
          this.add.image(x+32, 1408, "tile_road").setDepth(1);
        }
        for(let y=0;y<WorldHeight; y+=64){ // ä¸€æ¡å—åŒ—å‘è·¯
          this.add.image(1856, y+32, "tile_road").setDepth(1);
          this.add.image(1984, y+32, "tile_road").setDepth(1);
        }

        // æ”¾ç½® POI
        POIS.forEach(p=>{
          const key = {
            city_hall:"dot_cityhall",
            library:"dot_library",
            park:"dot_park",
            post_office:"dot_post",
            retail:"dot_retail"
          }[p.cat] || "dot_retail";

          const dot = this.add.image(p.x, p.y, key).setInteractive({useHandCursor:true});
          dot.on("pointerdown", ()=> openPanel(p));
          // æ ‡ç­¾ï¼ˆåƒç´ å­—ä½“ç”¨æ™®é€šæ–‡æœ¬ä»£æ›¿ï¼‰
          const label = this.add.text(p.x+16, p.y-10, p.name, {
            fontFamily: "Arial", fontSize: "12px", color: "#e6fff5", stroke:"#0a0f12", strokeThickness:3
          }).setDepth(10);
        });

        // é¼ æ ‡/è§¦æ‘¸æ‹–æ‹½ç›¸æœº
        this.input.on("pointerdown", (pointer)=>{
          dragging = true; dragX=pointer.x; dragY=pointer.y;
        });
        this.input.on("pointerup", ()=> dragging=false);
        this.input.on("pointermove", (pointer)=>{
          if(!dragging) return;
          const dx = pointer.x - dragX;
          const dy = pointer.y - dragY;
          camera.scrollX -= dx / camera.zoom;
          camera.scrollY -= dy / camera.zoom;
          dragX = pointer.x; dragY = pointer.y;
        });

        // é”®ç›˜ç§»åŠ¨
        cursors = this.input.keyboard.addKeys({ up:"W", left:"A", down:"S", right:"D" });

        // æ»šè½®ç¼©æ”¾ï¼ˆå¯é€‰ï¼‰
        this.input.on("wheel", (pointer, gameObjects, deltaX, deltaY)=>{
          const z = Phaser.Math.Clamp(camera.zoom - deltaY*0.001, 0.5, 2.5);
          camera.setZoom(z);
        });

        // è‡ªé€‚åº”çª—å£
        window.addEventListener("resize", ()=>{
          app.scale.resize(window.innerWidth, window.innerHeight);
        });
      }

      function update(){
        const speed = 8;
        if(cursors.left.isDown)  camera.scrollX -= speed;
        if(cursors.right.isDown) camera.scrollX += speed;
        if(cursors.up.isDown)    camera.scrollY -= speed;
        if(cursors.down.isDown)  camera.scrollY += speed;
      }

      // ç®€æ˜“é¢æ¿
      function openPanel(p){
        document.getElementById("poi-name").textContent = p.name;
        document.getElementById("poi-cat").textContent = p.cat;
        document.getElementById("poi-reward").textContent = p.reward || "+?";
        document.getElementById("poi-note").textContent = p.note || "";
        const panel = document.getElementById("poi-panel");
        panel.style.display = "block";
      }

      // ç‚¹å‡»é¡¶éƒ¨æ ‡é¢˜å¯å…³é—­é¢æ¿ï¼ˆä¹Ÿå¯è‡ªè¡ŒåŠ å…³é—­æŒ‰é’®ï¼‰
      document.querySelector(".hud").addEventListener("click", ()=>{
        document.getElementById("poi-panel").style.display = "none";
      });
    </script>
  </body>
</html>
